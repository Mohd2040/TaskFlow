# .github/workflows/build-and-push-backend-docker.yml
name: Build & Push Backend Docker Image and Deploy to Render


on:
  push:
    branches:
      - main
    paths:
      - 'backend/**' 

jobs:
  build-and-deploy: 
    name: Build, Push Docker Image, and Deploy to Render
    runs-on: ubuntu-latest 

      # 1. Checkout repository:
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # 2. Log in to GitHub Container Registry 
      - name: âš™ï¸ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} 

      # 3. Extract metadata (tags) for Docker image: Ø§Ø³ØªØ®Ù„Ø§Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙÙŠØ©
      - name: ğŸ“¦ Extract metadata (tags) for Docker image
        id: meta # Ø¥Ø¹Ø·Ø§Ø¡ Ù…Ø¹Ø±Ù Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø®Ø±Ø¬Ø§ØªÙ‡Ø§
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/taskflow-backend # Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ GHCR
          tags: |
            type=raw,value=latest,enable={{is_default_branch}} # Ø¹Ù„Ø§Ù…Ø© 'latest' Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            type=sha,format=long # Ø¹Ù„Ø§Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (commit SHA)

      # 4. Build and push Docker image: Ø¨Ù†Ø§Ø¡ ØµÙˆØ±Ø© Docker ÙˆØ¯ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ GHCR
      - name: âœ… Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend 
          push: true 
          tags: ${{ steps.meta.outputs.tags }} 
          labels: ${{ steps.meta.outputs.labels }} 
          cache-from: type=gha 
          cache-to: type=gha,mode=max

      - name: ğŸš€ Trigger Render Backend Deployment
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }} \
          --header 'Content-Type: application/json' \
          --data-binary '{}' \
          --fail-with-body 
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }} 
