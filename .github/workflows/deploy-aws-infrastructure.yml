# .github/workflows/deploy-aws-infrastructure.yml

# Ø§Ø³Ù… Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„
name: âœ”ï¸Deploy AWS Infrastructure with Terraform

on:
  push:
    branches:
      - main
    # ØªØ´ØºÙŠÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù…Ø¬Ù„Ø¯ 'devops/terraform/aws'
    paths:
      - 'devops/terraform/aws/**'

permissions:
  contents: read
  id-token: write # Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… OIDC (Ù…Ù…Ø§Ø±Ø³Ø© Ø¬ÙŠØ¯Ø©)

jobs:
  terraform-aws:
    name: âœ”ï¸Terraform Apply AWS
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository: Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      - name: ğŸ“¥Checkout repository
        uses: actions/checkout@v4

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Terraform: ØªØ«Ø¨ÙŠØª Terraform Ø¹Ù„Ù‰ Ø¨ÙŠØ¦Ø© GitHub Actions
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.x.x # Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø± (Ù…Ø«Ù„Ø§Ù‹ 1.5.0 Ø£Ùˆ Ø£Ø¹Ù„Ù‰)

      # 3. ØªÙ‡ÙŠØ¦Ø© Terraform (terraform init)
      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: devops/terraform/aws # ØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ù„Ù…Ù„ÙØ§Øª Terraform AWS
        env:
          # âœ… ØªÙ…Ø±ÙŠØ± AWS Credentials ÙƒÙ…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦Ø© Ù„Ù€ Terraform
          # Terraform Ø³ÙŠÙƒØªØ´ÙÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªÙ‡ÙŠØ¦Ø© Ù…Ø²ÙˆØ¯ AWS
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ vars.AWS_REGION }} # Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ ÙˆØ¶Ø¹Ù‡Ø§ ÙƒÙ€ Secret Ø£ÙŠØ¶Ø§Ù‹

      # 4. ØªØ®Ø·ÙŠØ· Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (terraform plan)
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        working-directory: devops/terraform/aws
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ vars.AWS_REGION }}
          # âœ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙŠ ØªØ¹Ø±ÙØªÙ‡Ø§ ÙÙŠ variables.tf
          TF_VAR_aws_region: ${{ vars.AWS_REGION }} # Ù…Ø«Ø§Ù„: eu-central-1
          TF_VAR_ssh_key_name: ${{ secrets.SSH_KEY_NAME }} # Ø§Ø³Ù… Ù…ÙØªØ§Ø­ SSH Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£ØªÙ‡ ÙÙŠ AWS
          # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ù…ØªØºÙŠØ±Ø§Øª Ø£Ø®Ø±Ù‰ ÙÙŠ variables.tf ÙˆÙ„ÙŠØ³ Ù„Ù‡Ø§ Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŒ Ù…Ø±Ø±Ù‡Ø§ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹.

      # 5. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (terraform apply)
      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve
        working-directory: devops/terraform/aws
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ vars.AWS_REGION }}
          TF_VAR_aws_region: ${{ vars.AWS_REGION }}
          TF_VAR_ssh_key_name: ${{ secrets.SSH_KEY_NAME }}
