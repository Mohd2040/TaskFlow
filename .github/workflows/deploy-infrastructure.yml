# .github/workflows/deploy-infrastructure.yml

name: âœ”ï¸Deploy Infrastructure with Terraform

on:
  push:
    # ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ± Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ 'main'
    # ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù…Ø¬Ù„Ø¯ 'devops/terraform'
    paths:
        - 'devops/terraform/**' # Ù‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ: Ø£ÙŠ ØªØºÙŠÙŠØ± Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ 'devops/terraform' Ø³ÙŠØ´ØºÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ±
    branches:
      - main

permissions:
  contents: read
  id-token: write # Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ Ø¨Ø§Ù„ØªÙˆÙƒÙ†

# ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Jobs) Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§
jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¹Ù„Ù‰ Ø¢Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ù†Ø¸Ø§Ù… Ubuntu

    # Ø®Ø·ÙˆØ§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©
    steps:
      # 1. Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: ğŸ“¥Checkout repository
        uses: actions/checkout@v4

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Terraform
      # Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙŠÙ‚ÙˆÙ… Ø¨ØªØ«Ø¨ÙŠØª Terraform Ø¹Ù„Ù‰ Ø¨ÙŠØ¦Ø© GitHub Actions
      - name: ğŸ”§Setup Terraform
        uses: hashicorp/setup-terraform@v3 # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù…Ù† HashiCorp
        with:
          terraform_version: 1.5.0 # Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø± (Ù…Ø«Ù„Ø§Ù‹ 1.5.0 Ø£Ùˆ Ø£Ø¹Ù„Ù‰)

      - name: ğŸ“¦Terraform Init
        id: init
        run: terraform init
        working-directory: devops/terraform # ØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±

      # 4. ØªØ®Ø·ÙŠØ· Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (terraform plan)
      # Ù‡Ø°Ø§ ÙŠØ¹Ø±Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§. ÙŠÙ…ÙƒÙ† Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ø§ ÙÙŠ Ø³Ø¬Ù„Ø§Øª GitHub Actions.
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        working-directory: devops/terraform
        env: # ØªÙ…Ø±ÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù„Ù€ Terraform
          TF_VAR_render_api_key: ${{ secrets.RENDER_API_KEY }}
          TF_VAR_render_owner_id: ${{ secrets.RENDER_OWNER_ID }}
          TF_VAR_mongo_uri: ${{ secrets.MONGO_URI }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}

      # 5. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (terraform apply)
      # Ù‡Ø°Ø§ ÙŠÙ‚ÙˆÙ… Ø¨ØªÙˆÙÙŠØ± (Ø£Ùˆ ØªØ­Ø¯ÙŠØ«) Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø¹Ù„Ù‰ Render.
      # ÙŠØ³ØªØ®Ø¯Ù… '-auto-approve' Ù„Ø£ØªÙ…ØªØ© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø©.
      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve
        working-directory: devops/terraform
        env: # ØªÙ…Ø±ÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù„Ù€ Terraform
          TF_VAR_render_api_key: ${{ secrets.RENDER_API_KEY }}
          TF_VAR_render_owner_id: ${{ secrets.RENDER_OWNER_ID }}
          TF_VAR_mongo_uri: ${{ secrets.MONGO_URI }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
