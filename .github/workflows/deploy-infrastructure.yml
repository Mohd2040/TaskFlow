# .github/workflows/deploy-infrastructure.yml
name: ‚úîÔ∏èDeploy Infrastructure with Terraform

on:
  push:

    paths:
        - 'devops/terraform/**' 
    branches:
      - main

permissions:
  contents: read
  id-token: write 

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest 
    if: false

    steps:
      - name: üì•Checkout repository
        uses: actions/checkout@v4

      - name: üîßSetup Terraform
        uses: hashicorp/setup-terraform@v3 
        with:
          terraform_version: 1.5.0 

      - name: üì¶Terraform Init
        id: init
        run: terraform init
        working-directory: devops/terraform 

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        working-directory: devops/terraform
        env: # 
          TF_VAR_render_api_key: ${{ secrets.RENDER_API_KEY }}
          TF_VAR_render_owner_id: ${{ secrets.RENDER_OWNER_ID }}
          TF_VAR_mongo_uri: ${{ secrets.MONGO_URI }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve
        working-directory: devops/terraform
        env: 
          TF_VAR_render_api_key: ${{ secrets.RENDER_API_KEY }}
          TF_VAR_render_owner_id: ${{ secrets.RENDER_OWNER_ID }}
          TF_VAR_mongo_uri: ${{ secrets.MONGO_URI }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
